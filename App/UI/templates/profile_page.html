{% extends "layout.html" %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='/css/profile_page.css') }}"/>
{% endblock %}

{% block title %}{{ visited_profile.user_name }}{% endblock %}

{% block content %}
<section class="profile-page">
<div class="p-content">
   <div class="container profile">
      <div class="row">
         <div class="col-md-6 ml-auto mr-auto">
            <div class="profile">
               <!--Profile picture-->
               <div class="avatar">
                   {% if visited_profile.profile_picture %}
                      <img src="data:image/jpg;base64,{{ visited_profile.profile_picture }}" alt="Circle Image" class="img-raised rounded-circle img-fluid">
                      {% else %}
                    <img src="{{ url_for('static', filename='/assets/img/dog.jpg') }}" alt="Circle Image" class="img-raised rounded-circle img-fluid">
                      {% endif %}                  
               </div>
               <!--Name on player-->
               <div class="name center-content-h" style="height: 35px;" >
                  {% if visited_profile._id|string not in current_user.friends|string and visited_profile.user_name != current_user.user_name %}
                  <div style="width: 35px">
                     <input type="image" class="post add_friend" id="img1" src="{{ url_for('static', filename='/assets/img/add_friend.png') }}" style="height: 100%; padding: 0; "/>
                  </div>
                  {% endif %}
                  <h3 class="title">{{ visited_profile.user_name }}</h3>
               </div>
            </div>
         </div>
      </div>
      <!--Descprition player-->
      <div class="description text-center" id="rating_text">
         <p> {% if visited_profile.rating %}
            Rating:
            {{ visited_profile.rating|int }}
            {% else  %}
            No Rating Calculated
            {% endif %}
         </p>
      </div>
      <!--Row for tablink (settings, friends, fav course)-->
      <div class="row" style="display: -ms-flexbox;">
         <div class="col-sm-12 ml-auto mr-auto">
            <div class="profile-tabs">
               <ul class="nav nav-pills nav-pills-icons justify-content-center" role="tablist" >
                  <li class="nav-item">
                     <a class="nav-link active" data-target="#my_stats" role="tab" data-toggle="tab" onclick="show_tab('my_stats')" >
                     <i class="material-icons"><img src="{{ url_for('static', filename='/assets/img/baseline_insights_black_24dp.png') }}" ></i>
                     My Stats
                     </a>
                  </li>
                  {% if visited_profile.user_name == current_user.user_name %}
                  <li class="nav-item">
                     <a class="nav-link" data-target="#settings" role="tab" data-toggle="tab" onclick="show_tab('settings')" >
                     <i class="material-icons"><img src="{{ url_for('static', filename='/assets/img/baseline_settings_black_24dp.png') }}"> </i>
                     Settings
                     </a>
                  </li>
                  {% endif %}
                  <li class="nav-item">
                     <a class="nav-link" data-target="#friends" role="tab" data-toggle="tab" onclick="show_tab('friends')" >
                     <i class="material-icons"><img src="{{ url_for('static', filename='/assets/img/baseline_people_alt_black_24dp.png') }}" id="friend_logo_image" style="height: 48px;"></i>
                     Friends
                     </a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link"  data-target="#favorite_coruses" role="tab" data-toggle="tab" onclick="show_tab('favorite_courses')" >
                     <i class="material-icons" id="favorite_courses_button"><img src="{{ url_for('static', filename='/assets/img/baseline_favorite_black_24dp.png') }}"></i>
                     Favorite Courses
                     </a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" data-target="#scorecards" role="tab" data-toggle="tab" onclick="show_tab('scorecards')" >
                     <i class="material-icons"><img src="{{ url_for('static', filename='/assets/img/scorecard_img.png') }}" id="scorecard_logo_image" style="height: 48px;"></i>
                     Scorecards
                     </a>
                  </li>
               </ul>
            </div>
         </div>
      </div>
      <div class="tab-content tab-space" id="profile_content">
         <!--Put content when pressed my_stats-->
         <div class="tab-pane active text-center gallery" id="my_stats" style="padding-top: 20px;">
            <div class="container-fluid">
               <!-- Example row of columns -->
               <div class="row">
                  <figure class="highcharts-figure" style="width: 100vw;" >
                     <div id="container">
                     </div>
                  </figure>
               </div>
            </div>

            <div class="cont w100 center-content-h" style="margin-bottom: 2.5rem">
               <div class="cont" style="width: 33%">
                  <button class="rounds" value="5">5</button>
               </div>
               <div class="cont" style="width: 33%">
                  <button class="rounds" value="20">20</button>
               </div>
               <div class="cont" style="width: 33%">
                  <button class="rounds" value="50">50</button>
               </div>
            </div>
         </div>
         <!--Put content when pressed settings-->
         {% if visited_profile.user_name == current_user.user_name %}
         <div class="tab-pane text-center gallery" id="settings"style="display: none" >
            <div class="settings-panel">
                {% if form.profile_picture_input.errors %}
                    <ul class="errors">{% for error in form.profile_picture_input.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}
               <form action="{{ url_for('profile.profile_page_update') }}" role="form" method="POST" enctype="multipart/form-data">
                  {{ form.csrf_token }}
                   <div id="settings-profile-picture">
                       <label id="settings-profile-picture-button" for="profile_picture_input">Upload File</label>
                       <div id="settings-profile-picture-filename">No file choosen</div>
                       {{ form.profile_picture_input }}
                   </div>
                   <div id="settings-user-name">{{ form.user_name }}</div>
                   <div id="settings-email"> {{ form.email}} </div>
                   <div id="settings-password">{{ form.password }}{{ form.confirm_password }}</div>
                   <div id="current-password">{{ form.current_password }}</div>
                   <div id="settings-submit">{{ form.submit }}</div>
               </form>
           </div>
         </div>
         {% endif %}
         <!--Put content when pressed friends-->
         <div class="tab-pane text-center gallery" id="friends" >
            <div class="col-search-form" style="display: flex; justify-content: center; width: 100%;">
               <form class="form-inline active-cyan-3 active-cyan-4 center-content" autocomplete="off" style="width: 100%; max-width: 500px">
                  <div class=autocomplete aria-hidden="true" style="width: 100%">
                     <input class="form-control form-control-m w-100" id="user_search" type="text" placeholder="Search Players" aria-label="Search" style="margin-bottom: 10px; margin-top: 10px; display: flex; justify-content: center; background-color: #fef9c7">
                  </div>
               </form>

            </div>
            <div class="row" id="friends_id">
            </div>
         </div>
         <!--Put content when pressed favorite course-->
         <div class="tab-pane text-center gallery" id="favorite_courses">
            <p>Gå till courses för att lägga till bana</p>
            <div id="favorite-courses-tag" >
               {% for course in favorite_courses %}
               <h3 id="id_courses">{{ course }}</h3>
               {% endfor %}
            </div>
         </div>
         <div class="tab-pane text-center gallery" id="scorecards" >
         {% if visited_profile.user_name == current_user.user_name %}
            <div class="incomplete_scorecards">
               <form role="form" method="POST">
                  {% for scorecard in current_user.incomplete_scorecards %}
                  <button class="btn btn-primary btn-m w-100 button-text score_buttons" id='incomplete_s_id' type="submit"  name="button" value="{{ scorecard._id }}">{{ scorecard.course }} (Incomplete round)</button>
                  {% endfor %}
               </form>
            </div>
         {% endif %}
            <div class="complete_scorecards">
                <form role="form" method="POST">
                {% for scorecard in visited_profile.complete_scorecards %}
                    <button class="btn btn-primary btn-m w-100 button-text score_buttons" id="complete_s_id" type="submit" name="button" value="{{ scorecard._id }}">{{ scorecard.course }} (Completed round)</button>
                {% endfor %}
                </form>
            </div>
         </div>
      </div>
   </div>
</div>

</section>
{% endblock %}
{%block javascript %}<!--High CHART LIVE  -->

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="{{ url_for('static', filename='/js/profile_page.js') }}"></script>
    <script>
    console.log({{ favorite_courses|safe }})
        let request_list = {}

        {% for req in current_user.friend_requests %}
            request_list["{{req.user_name}}"] = "{{req.full_name}}"
        {% endfor %}


        if (!jQuery.isEmptyObject(request_list)) {
            $('#friend_logo_image')[0].src = "{{ url_for('static', filename='/assets/img/friend_request.png') }}"
            for (let username in request_list) {

                let parent = document.getElementById('friends_id')

                let block_to_insert = document.createElement('div')
                block_to_insert.className= "col-container w100 center-content-h"
                block_to_insert.style.height = '50px'
                block_to_insert.innerHTML = request_list[username];


                let friend_link = document.createElement("a");
                friend_link.setAttribute("href","/profile_page/" + username);
                friend_link.innerHTML = username;

                let accept_request = document.createElement("input");
                accept_request.setAttribute("type", "image");
                accept_request.setAttribute("id", username);
                accept_request.setAttribute("class", "post accept_request");
                accept_request.setAttribute("src", "{{ url_for('static', filename='/assets/img/check_mark.png') }}");
                accept_request.style.height="100%"

                let decline_request = document.createElement("input");
                decline_request.setAttribute("type", "image");
                decline_request.setAttribute("id", username);
                decline_request.setAttribute("class", "action decline_request");
                decline_request.setAttribute("src", "{{ url_for('static', filename='/assets/img/red_cross.jpg') }}");
                decline_request.style.height="100%"

                block_to_insert.appendChild(friend_link)
                block_to_insert.appendChild(accept_request)
                block_to_insert.appendChild(decline_request)

                parent.appendChild(block_to_insert)
            }
        }

        $('.rounds').click(function () {
            player_history = {{ visited_profile.history|safe }}
            player_history = player_history.slice(Math.max(player_history.length - this.value, 0));
            render_chart(player_history);
        });

        let all_users = {{all_users|tojson|safe}};
        let friends = {}

        {% for friend in visited_profile.friends_list %}
            friends["{{friend.user_name}}"] = "{{friend.full_name}}"
        {% endfor %}
         {% if visited_profile.user_name == current_user.user_name %}
            show_friends()
        {% endif %}
        $(".action").click(function (){
            $.ajax({
                method: 'delete',
                url: "/profile_page/{{ visited_profile.user_name }}",
                data: {
                    username: this.id,
                    action: this.className
                },
                success: (data) => {
                    alert(this.id + ' ' + data)

                    delete request_list[this.id]

                    if (jQuery.isEmptyObject(request_list)) {
                            $('#friend_logo_image')[0].src = "{{ url_for('static', filename='/assets/img/baseline_people_alt_black_24dp.png') }}"
                        }
                },
            })
            $(this).parent().remove();
        })



    </script>
    <script src="{{ url_for('static', filename='/js/mystats_chart.js') }}"></script>
    <script src="{{ url_for('static', filename='/js/create_scorecard.js') }}"></script>

    <script>
        autocomplete(document.getElementById("user_search"), all_users, course=false, all_users=true );

        let player_history = {{ visited_profile.history|safe }}
        player_history = player_history.slice(Math.max(player_history.length - 20, 0));
        render_chart(player_history);

        $('.post').click(function (){
            $.ajax({
                method: 'post',
                url: "/profile_page/{{ visited_profile.user_name }}",
                data: {
                    id: "{{ visited_profile._id }}",
                    action: this.className,
                    request_username: this.id
                },
                success: (data) => {
                    if (this.id !== 'img1') {
                        alert( this.id + ' ' + data)

                        friends[this.id] = "New pal"
                        delete request_list[this.id]

                        show_friends()

                        if (jQuery.isEmptyObject(request_list)) {
                            $('#friend_logo_image')[0].src = "{{ url_for('static', filename='/assets/img/baseline_people_alt_black_24dp.png') }}"
                        }
                    }
                    else {
                        alert('{{ visited_profile.user_name }}' + ' ' + data)
                    }
                },
            })
            $(this).parent().remove()
        });



    </script>
    {% endblock %}
