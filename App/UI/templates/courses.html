{% extends "base_logged_in.html" %}
{% block css %}
<link rel="stylesheet" type="text/css" href="../static/css/courses.css"/>
{% endblock %}

{% block content %}

<div id="courses-page">
    <!-- Search form -->
    <div id="courses-container">
        <div id="courses-search">
            <input id="courses-search-input" type="text"placeholder="Search" style="border: #6e6e6e 1px solid; border-radius: 5px; outline: none;">
        </div>
        <div id="courses-list">
        </div>
    </div>

    <!--Google map-->
    <div id="map-container">
        <div id="map-frame" >
            <iframe src="https://www.google.com/maps/d/embed?mid=1BKnIaG_SE17mmhzPZcj_ZUvZ7Oo" width="100%" height="98.5%"></iframe>
        </div>

    </div>


</div>



{% endblock %}
{% block javascript %}
<script>
var all_courses = {{ all_courses|safe }}
all_courses.sort((a, b) => {a.toUpperCase();b.toUpperCase();return a > b ? 1 : a < b ? -1 : 0;});
var favorites;

function getFavorites(){
    return $.post(
        "/courses",
        {loading: true},
        (response) => {console.log(response["favorites"]);},
        "json");
}

function setFavorite(course){
    return $.post(
        "/courses",
        {course: course},
        (response) => {console.log(response)},
        "json");
}
{% if not current_user.is_anonymous %}
getFavorites().done((r) => {
    favorites = r["favorites"];
    autocomplete(document.getElementById("courses-search-input"), all_courses);
    getAllCourses(all_courses);
});
{% else %}
autocomplete(document.getElementById("courses-search-input"), all_courses);
getAllCourses(all_courses);
{% endif %}
function getAllCourses(arr) {
    var course, icon, courseText, courseName, i;
    var list = document.getElementById("courses-list")
    /*close any already open lists of autocompleted values*/
    emptyCourseList();

    /*for each item in the array...*/
    for (i = 0; i < arr.length; i++) {
        /*create a DIV element for each matching element:*/
        course = document.createElement("DIV");
        course.setAttribute("class", "course");
        list.appendChild(course);

        {% if not current_user.is_anonymous %}
        icon = document.createElement("img");
        if (favorites.includes(arr[i])){
            icon.setAttribute("src", "../static/assets/img/star_filled.svg")}
        else {
            icon.setAttribute("src", "../static/assets/img/star_empty.svg")}
        icon.setAttribute("alt", "fav");
        icon.setAttribute("width", "30px");
        icon.setAttribute("height", "30px");
        icon.setAttribute("style", "margin: 10px");
        icon.addEventListener("click", updateFavorite)
        course.appendChild(icon);
        {% endif %}

        courseText = document.createElement("DIV");
        courseText.setAttribute("class", "course-text");
        course.appendChild(courseText);

        courseName = document.createElement("h4");
        courseName.innerHTML = arr[i];
        /*insert a input field that will hold the current array item's value:*/
        courseName.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
        /*execute a function when someone clicks on the item value (DIV element):*/
        courseName.addEventListener("click", function (e) {
            inp.value = this.getElementsByTagName("input")[0].value;
        });
        courseText.appendChild(courseName);
    }
}

function autocomplete(inp, arr) {
    /*execute a function when someone writes in the text field:*/
    inp.addEventListener("input", function() {
        var course, icon, courseText, courseName, i, regex = new RegExp("^"+this.value.toUpperCase());
        var list = document.getElementById("courses-list")
        /*close any already open lists of autocompleted values*/
        emptyCourseList();
        if (!this.value) {
            getAllCourses(arr);
        }
        /*for each item in the array...*/
        for (i = 0; i < arr.length; i++) {
            /*check if the item starts with the same letters as the text field value:*/
            if (arr[i].toUpperCase().match(regex)){
                /*create a DIV element for each matching element:*/
                course = document.createElement("div");
                course.setAttribute("class", "course");
                list.appendChild(course);
                {% if not current_user.is_anonymous %}
                icon = document.createElement("img");
                if (favorites.includes(arr[i])){
                    icon.setAttribute("src", "../static/assets/img/star_filled.svg");}
                else {
                    icon.setAttribute("src", "../static/assets/img/star_empty.svg");}
                icon.setAttribute("alt", "fav");
                icon.setAttribute("width", "30px");
                icon.setAttribute("height", "30px");
                icon.setAttribute("style", "margin: 10px");
                icon.addEventListener("click", updateFavorite);
                course.appendChild(icon);
                {% endif %}
                courseText = document.createElement("DIV");
                courseText.setAttribute("class", "course-text");
                course.appendChild(courseText);

                courseName = document.createElement("h4");

                courseName.innerHTML = arr[i];
                /*insert a input field that will hold the current array item's value:*/
                courseName.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                /*execute a function when someone clicks on the item value (DIV element):*/
                courseName.addEventListener("click", function (e) {
                    inp.value = this.getElementsByTagName("input")[0].value;
                });
                courseText.appendChild(courseName);
            }
        }
    });
}

function emptyCourseList() {
        const x = document.getElementById("courses-list");
        x.innerHTML = "";
        return true
}
{% if not current_user.is_anonymous %}
function updateFavorite(){
    let course = this.parentNode.getElementsByClassName("course-text")[0].getElementsByTagName("input")[0].value;
    setFavorite(course).done((r1) => {
        getFavorites().done((r2) => {
            favorites = r2["favorites"];
            if (favorites.includes(course)){this.setAttribute("src", "../static/assets/img/star_filled.svg");}
            else{this.setAttribute("src", "../static/assets/img/star_empty.svg");}
        });
    });
}
{% endif %}
</script>
{% endblock %}