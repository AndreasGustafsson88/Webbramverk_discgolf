{% extends "layout.html" %}
{% block css %}
<style type="text/css">
    .round-circle {
        border-radius: 50%;
        width: 100px;
        height: 100px;
    }
</style>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='/css/profile_page.css') }}"/>
{% endblock %}

{% block title %}{{ visited_profile.user_name }}{% endblock %}

{% block content %}
    <section class="profile_page_test">
        <div class="container-fluid" style="min-height: 90vh; background-color:#35ffbc; padding: 0">
            <div class="settings-header" style="height: 50px; background-color: #7fffd4; display: flex; justify-content: center;">
                <div class="settings-bar center-content" style="width: 20%; background-color: #FFE4C4; margin: 5px;">
                    <div class="settings-icon center-content" style="width: 100%; height: 100%;" onclick='show_stats()'>
                        <img src="{{ url_for('static', filename='/assets/img/baseline_insights_black_24dp.png') }}">
                    </div>
                </div>
                <div class="settings-bar" style="width: 20%; background-color: #ffe4c4; margin: 5px;">
                    <div class="settings-icon center-content" style="width: 100%; height: 100%;" onclick="show_scorecards()">
                        <img src="{{ url_for('static', filename='/assets/img/scorecard_img.png') }}">
                    </div>
                </div>
                <div class="settings-bar" style="width: 20%; background-color: bisque; margin: 5px;">
                    <div class="settings-icon center-content" style="width: 100%; height: 100%;">
                        <a class="nav-link" data-target="#settings" role="tab" data-toggle="tab" onclick="show_friends('{{ visited_profile.user_name }}', '{{ current_user.user_name }}')" >
                            <img src="{{ url_for('static', filename='/assets/img/baseline_people_alt_black_24dp.png') }}">
                        </a>
                    </div>
                </div>
                <div class="settings-bar" style="width: 20%; background-color: bisque; margin: 5px;">
                    <div class="settings-icon center-content" style="width: 100%; height: 100%;" onclick="show_favourite_courses()">
                        <img src="{{ url_for('static', filename='/assets/img/baseline_favorite_black_24dp.png') }}">
                    </div>
                </div>
                <div class="settings-bar" style="width: 20%; background-color: bisque; margin: 5px;">
                    <div class="settings-icon center-content" style="width: 100%; height: 100%;" role="tab" data-toggle="tab" onclick="show_settings()">
                        <img src="{{ url_for('static', filename='/assets/img/baseline_settings_black_24dp.png') }}">
                    </div>
                </div>
            </div>
            <div class="profile_header" style="height: 150px; background-color: beige; border-bottom-left-radius: 100%; border-left: 5px solid rgb(127,255,212); position: relative; overflow: hidden;">
                <div class="profile-avatar center-content-h">
                    {% if visited_profile.profile_picture %}
                        <img src="data:image/jpg;base64,{{ visited_profile.profile_picture }}" alt="Circle Image" class="round-circle">
                    {% else %}
                        <img src="{{ url_for('static', filename='/assets/img/dog.jpg') }}" alt="Circle Image" class="img-raised rounded-circle img-fluid">
                    {% endif %}
                </div>
                <div class="name" style="height: 35px; float: right; margin-right: 10px; margin-top: 5%">
                    {% if visited_profile._id|string not in current_user.friends|string and visited_profile.user_name != current_user.user_name %}
                        <div style="width: 35px">
                            <input type="image" class="post add_friend" id="img1" src="{{ url_for('static', filename='/assets/img/add_friend.png') }}" style="height: 100%; padding: 0; "/>
                        </div>
                    {% endif %}
                    <h3 class="title">{{ visited_profile.user_name }}</h3>
                </div>
                    <div class="description text-center" id="rating_text" style="float: right; clear: both; margin-right: 10px">
                        <p>
                            {% if visited_profile.rating %}
                            Rating:
                            {{ visited_profile.rating|int }}
                            {% else  %}
                            No Rating Calculated
                            {% endif %}
                        </p>
                </div>
            </div>

            <!-- CONTENT -->

            <div class="profile-page-content" id="profile_content" style="height: 500px; background-color: #35ffbc">
                <div id="active_content">
                    <div class="container-fluid">
                        <div class="row">
                            <figure class="highcharts-figure" style="width: 100vw;" >
                                <div id="container"></div>
                            </figure>
                        </div>
                    </div>

                    <div class="cont w100 center-content-h" style="margin-bottom: 2.5rem">
                        <div class="cont" style="width: 33%">
                            <button class="rounds" value="5">5</button>
                        </div>
                        <div class="cont" style="width: 33%">
                            <button class="rounds" value="20">20</button>
                        </div>
                        <div class="cont" style="width: 33%">
                            <button class="rounds" value="50">50</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>
{% endblock %}

{%block javascript %}
    <script src="{{ url_for('static', filename='/js/mystats_chart.js') }}"></script>
    <script>
        let all_users = {{all_users|tojson|safe}};
        let friends = {}
        let player_history = {{ visited_profile.history|safe }}
        $(document).ready(render_chart(player_history))
        {# TODO ONCLICK INSTEAD, BEHÃ–VER INTE HA DUBBEL#}
        $('.rounds').click(function () {
            let p_history = player_history.slice(Math.max(player_history.length - this.value, 0));
            render_chart(p_history);
        });
    </script>
    <script src="{{ url_for('static', filename='/js/create_scorecard.js') }}"></script>
    <script src="{{ url_for('static', filename='/js/profile_test.js') }}"></script>
    <script>
    {% if visited_profile.user_name == current_user.user_name %}
        function show_settings() {
            let active = document.getElementById('active_content');
            active.innerHTML = ""
        $('<div class="tab-pane text-center gallery" id="settings">' +
            '<div class="settings-panel">' {% if form.profile_picture_input.errors %} + '<ul class="errors">' {% for error in form.profile_picture_input.errors %} + '<li>{{ error }}</li>' {% endfor %} + '</ul>' {% endif %} +
            '<form action="' + '{{ url_for("profile.profile_page_update") }}' + '"' + 'role="form" method="POST" enctype="multipart/form-data">' +
            '{{ form.csrf_token }}' + '<div id="settings-profile-picture">' + '<label id="settings-profile-picture-button" for="profile_picture_input">Upload File</label>' + '<div id="settings-profile-picture-filename">No file choosen</div>' +
            '{{ form.profile_picture_input }}' + '</div>' +
            '<div id="settings-user-name">{{ form.user_name }}</div>' +
            '<div id="settings-email"> {{ form.email}} </div>' +
            '<div id="settings-password">{{ form.password }}{{ form.confirm_password }}</div>' +
            '<div id="current-password">{{ form.current_password }}</div>' +
            '<div id="settings-submit">{{ form.submit }}</div>' + '</form></div></div>').appendTo('#active_content');
        }
    {% endif %}

    function show_scorecards() {
        let active_content = $('#active_content')
        active_content.empty()

        let html = ''
        {% if visited_profile.user_name == current_user.user_name %}
            html += '<div class="incomplete_scorecards">' +
                '<form role="form" method="POST">'
                {% for scorecard in current_user.username %}
                    html += `<button class="btn btn-primary btn-m w-100 button-text score_buttons" id="incomplete_s_id" type="submit"  name="button" value="{{ scorecard._id }}">{{ scorecard.course }} (Incomplete round)</button>`
                {% endfor %}
                html += '</form></div>'
        {% endif %}
        html += '<div class="complete_scorecards">' +
            '<form role="form" method="POST">'
            {% for scorecard in visited_profile.complete_scorecards %}
                html += `<button class="btn btn-primary btn-m w-100 button-text score_buttons" id="complete_s_id" type="submit" name="button" value="{{ scorecard._id }}">{{ scorecard.course }} (Completed round)</button>`
            {% endfor %}
        $(html).appendTo(active_content)
    }

    </script>
    <!-- NEW -->

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
        let request_list = {}
        {% for req in current_user.friend_requests %}
            request_list["{{req.user_name}}"] = "{{req.full_name}}"
        {% endfor %}

        if (!jQuery.isEmptyObject(request_list)) {
            $('#friend_logo_image')[0].src = "{{ url_for('static', filename='/assets/img/friend_request.png') }}"
            for (let username in request_list) {

                let parent = document.getElementById('active_content')
                parent.innerHTML = ''

                let block_to_insert = document.createElement('div')
                block_to_insert.className= "col-container w100 center-content-h"
                block_to_insert.style.height = '50px'
                block_to_insert.innerHTML = request_list[username];


                let friend_link = document.createElement("a");
                friend_link.setAttribute("href","/profile_page/" + username);
                friend_link.innerHTML = username;

                let accept_request = document.createElement("input");
                accept_request.setAttribute("type", "image");
                accept_request.setAttribute("id", username);
                accept_request.setAttribute("class", "post accept_request");
                accept_request.setAttribute("src", "{{ url_for('static', filename='/assets/img/check_mark.png') }}");
                accept_request.style.height="100%"

                let decline_request = document.createElement("input");
                decline_request.setAttribute("type", "image");
                decline_request.setAttribute("id", username);
                decline_request.setAttribute("class", "action decline_request");
                decline_request.setAttribute("src", "{{ url_for('static', filename='/assets/img/red_cross.jpg') }}");
                decline_request.style.height="100%"

                block_to_insert.appendChild(friend_link)
                block_to_insert.appendChild(accept_request)
                block_to_insert.appendChild(decline_request)

                parent.appendChild(block_to_insert)
            }
        }

        {% for friend in visited_profile.friends_list %}
            friends["{{friend.user_name}}"] = "{{friend.full_name}}"
        {% endfor %}

        $(".action").click(function (){
            $.ajax({
                method: 'delete',
                url: "/profile_page/{{ visited_profile.user_name }}",
                data: {
                    username: this.id,
                    action: this.className
                },
                success: (data) => {
                    alert(this.id + ' ' + data)

                    delete request_list[this.id]

                    if (jQuery.isEmptyObject(request_list)) {
                            $('#friend_logo_image')[0].src = "{{ url_for('static', filename='/assets/img/baseline_people_alt_black_24dp.png') }}"
                        }
                },
            })
            $(this).parent().remove();
        })
    </script>
    <script>
        $('.post').click(function (){
            $.ajax({
                method: 'post',
                url: "/profile_page/{{ visited_profile.user_name }}",
                data: {
                    id: "{{ visited_profile._id }}",
                    action: this.className,
                    request_username: this.id
                },
                success: (data) => {
                    if (this.id !== 'img1') {
                        alert( this.id + ' ' + data)

                        friends[this.id] = "New pal"
                        delete request_list[this.id]

                        show_friends()

                        if (jQuery.isEmptyObject(request_list)) {
                            $('#friend_logo_image')[0].src = "{{ url_for('static', filename='/assets/img/baseline_people_alt_black_24dp.png') }}"
                        }
                    }
                    else {
                        alert('{{ visited_profile.user_name }}' + ' ' + data)
                    }
                },
            })
            $(this).parent().remove()
        });



    </script>
    {% endblock %}
